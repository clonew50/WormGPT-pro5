<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>WormGPT Ultimate</title>
    
    <!-- مكتبات خارجية -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark-reasonable.min.css" rel="stylesheet">

    <style>
        :root {
            /* الألوان الأساسية */
            --accent: #ff0040;
            --accent-glow: rgba(255, 0, 64, 0.3);
            --accent-green: #00ff88;
            --accent-blue: #0088ff;
            --accent-gold: #FFD700;
            --bg-main: #050505;
            --bg-card: #141414;
            --bg-card-hover: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border-color: #27272a;
            --code-bg: #1e1e1e;
            
            /* قياسات */
            --header-h: 65px;
            --radius-lg: 20px;
            --radius-sm: 10px;
        }

        /* --- إعدادات عامة --- */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
        }
        
        html, body {
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 16px;
            line-height: 1.6;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(255, 0, 64, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 136, 255, 0.03) 0%, transparent 50%);
        }

        /* شريط التمرير المخصص */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* --- الهيدر --- */
        .app-header {
            height: var(--header-h);
            background: linear-gradient(135deg, rgba(5, 5, 5, 0.98), rgba(20, 0, 10, 0.98));
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 0, 64, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 50;
            position: relative;
            width: 100%;
            box-shadow: 0 4px 30px rgba(255, 0, 64, 0.1);
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 900;
            font-size: 1.3rem;
            letter-spacing: 0.5px;
            background: linear-gradient(90deg, var(--accent), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            padding-right: 10px;
        }

        .logo-icon {
            color: var(--accent);
            filter: drop-shadow(0 0 8px var(--accent));
            animation: float 3s ease-in-out infinite;
            font-size: 1.5rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* زر البرو */
        .pro-badge {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 140, 0, 0.2));
            border: 1px solid rgba(255, 215, 0, 0.4);
            color: var(--accent-gold);
            padding: 8px 14px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            height: 40px;
            position: relative;
            overflow: hidden;
        }

        .pro-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .pro-badge:hover::before {
            left: 100%;
        }

        .pro-badge:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 140, 0, 0.3));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
        }

        .pro-badge.pro-active {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.35), rgba(255, 140, 0, 0.35));
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            animation: pulse-gold 2s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
        }

        /* شارة النموذج */
        .model-badge {
            background: rgba(0, 136, 255, 0.2);
            border: 1px solid rgba(0, 136, 255, 0.4);
            color: var(--accent-blue);
            padding: 8px 14px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            height: 40px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .model-badge.v3 {
            background: rgba(0, 255, 136, 0.2);
            border-color: rgba(0, 255, 136, 0.4);
            color: var(--accent-green);
        }

        /* أزرار الهيدر */
        .header-controls button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-controls button:hover, .header-controls button.active {
            background: rgba(255, 0, 64, 0.15);
            color: var(--accent);
            border-color: rgba(255, 0, 64, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 64, 0.2);
        }

        /* شارة البحث */
        .web-search-badge {
            background: rgba(0, 255, 136, 0.15);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--accent-green);
            padding: 8px 14px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            cursor: pointer;
            height: 40px;
        }

        .web-search-badge:hover {
            background: rgba(0, 255, 136, 0.25);
            border-color: var(--accent-green);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.2);
        }

        .web-search-badge.active {
            background: rgba(0, 255, 136, 0.3);
            color: #fff;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        /* --- نافذة تفعيل البرو --- */
        .pro-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fade-in 0.3s;
        }

        .pro-modal.active {
            display: flex;
        }

        .pro-card {
            background: linear-gradient(135deg, rgba(25, 15, 25, 0.95), rgba(15, 5, 20, 0.95));
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 25px;
            width: 90%;
            max-width: 450px;
            padding: 35px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.7);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .pro-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.05) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        .pro-icon {
            font-size: 3.5rem;
            color: var(--accent-gold);
            margin-bottom: 20px;
            animation: pulse-gold 2s infinite;
        }

        .pro-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-gold);
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .pro-features {
            text-align: right;
            margin: 25px 0;
            padding: 0 10px;
        }

        .pro-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            color: var(--text-secondary);
            font-size: 0.95rem;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .pro-feature:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        .pro-feature i {
            color: var(--accent-gold);
            font-size: 1.1rem;
        }

        .pro-input {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 15px;
            color: white;
            font-size: 1.1rem;
            margin: 20px 0;
            text-align: center;
            letter-spacing: 3px;
            font-family: 'Fira Code', monospace;
            transition: all 0.3s;
        }

        .pro-input:focus {
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2), 0 10px 30px rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
            outline: none;
        }

        .pro-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #FFD700, #FF8C00);
            border: none;
            border-radius: 15px;
            color: #000;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }

        .pro-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(255, 215, 0, 0.4);
        }

        .pro-close {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #ccc;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pro-close:hover {
            background: rgba(255, 0, 64, 0.2);
            color: white;
            transform: rotate(90deg);
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- منطقة المحادثة --- */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 15px;
            scroll-behavior: smooth;
            width: 100%;
            overflow-x: hidden;
        }

        .message-wrapper {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            animation: slide-up 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 100%;
            max-width: 100%;
        }

        .message-wrapper.user { 
            flex-direction: row-reverse; 
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1rem;
            background: linear-gradient(135deg, var(--bg-card), #1a1a1a);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .message-wrapper.bot .avatar { 
            color: var(--accent); 
            background: linear-gradient(135deg, rgba(255, 0, 64, 0.1), rgba(255, 0, 64, 0.05));
            border-color: rgba(255, 0, 64, 0.2);
        }

        .message-wrapper.user .avatar { 
            color: #fff; 
            background: linear-gradient(135deg, #333, #444);
        }

        .bubble {
            max-width: 85%;
            padding: 16px 20px;
            border-radius: 18px;
            line-height: 1.7;
            font-size: 1rem;
            position: relative;
            word-wrap: break-word;
            text-align: right;
            overflow-wrap: break-word;
            word-break: break-word;
            min-width: 0;
        }

        .bubble p {
            margin-bottom: 15px;
            max-width: 100%;
            overflow-wrap: break-word;
        }

        .bubble p:last-child {
            margin-bottom: 0;
        }

        .bubble ul, .bubble ol {
            margin-right: 25px;
            margin-bottom: 15px;
            padding: 0;
            max-width: 100%;
        }

        .bubble li {
            margin-bottom: 8px;
            overflow-wrap: break-word;
            padding-right: 5px;
            position: relative;
        }

        .bubble li::before {
            content: '•';
            color: var(--accent);
            font-weight: bold;
            position: absolute;
            right: -18px;
        }

        .message-wrapper.bot .bubble {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.95), rgba(30, 10, 20, 0.95));
            border: 1px solid rgba(255, 0, 64, 0.15);
            border-top-right-radius: 8px;
            color: #f0f0f0;
            margin-left: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }

        .message-wrapper.bot .bubble::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(45deg, transparent, rgba(255, 0, 64, 0.05), transparent);
            pointer-events: none;
        }

        .message-wrapper.user .bubble {
            background: linear-gradient(135deg, #ff0040, #ff3366);
            color: white;
            border-top-left-radius: 8px;
            box-shadow: 0 10px 35px rgba(255, 0, 64, 0.4);
            margin-right: 10px;
            position: relative;
            overflow: hidden;
        }

        .message-wrapper.user .bubble::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            pointer-events: none;
        }

        /* شارة الهوية */
        .identity-badge {
            display: inline-block;
            background: linear-gradient(135deg, rgba(255, 0, 64, 0.2), rgba(0, 136, 255, 0.2));
            border: 1px solid rgba(255, 0, 64, 0.3);
            color: var(--accent);
            font-size: 0.85rem;
            font-weight: 800;
            padding: 6px 14px;
            border-radius: 10px;
            margin-bottom: 15px;
            animation: badge-pulse 3s infinite;
            letter-spacing: 1px;
        }

        /* أزرار النسخ */
        .copy-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 0, 64, 0.3);
            color: #ddd;
            padding: 10px 18px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'Tajawal', sans-serif;
            position: relative;
            overflow: hidden;
        }

        .copy-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 0, 64, 0.2), transparent);
            transition: left 0.6s;
        }

        .copy-btn:hover::before {
            left: 100%;
        }

        .copy-btn:hover {
            background: rgba(255, 0, 64, 0.25);
            color: white;
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 0, 64, 0.3);
        }

        .copy-btn i {
            font-size: 1rem;
        }

        /* زر نسخ الكود */
        .code-block-wrapper {
            position: relative;
            margin: 20px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.4);
        }

        .code-copy-btn {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(40, 30, 40, 0.9);
            border: 1px solid #555;
            color: #ddd;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .code-block-wrapper:hover .code-copy-btn {
            opacity: 1;
        }

        .code-copy-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 6px 25px rgba(255, 0, 64, 0.4);
            transform: translateY(-2px);
        }

        /* التنبيهات */
        .feature-locked {
            background: linear-gradient(135deg, rgba(255, 0, 64, 0.15), rgba(255, 0, 64, 0.05));
            border: 1px solid rgba(255, 0, 64, 0.3);
            color: #ffb3c8;
            padding: 12px 18px;
            border-radius: 12px;
            margin: 15px 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: pulse-red 2s infinite;
            flex-wrap: wrap;
        }

        .feature-locked i {
            color: var(--accent);
            font-size: 1.1rem;
        }

        .unlock-btn {
            background: linear-gradient(135deg, #FFD700, #FF8C00);
            border: none;
            border-radius: 8px;
            color: #000;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            margin-right: auto;
            transition: all 0.3s;
        }

        .unlock-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        /* --- منطقة الإدخال --- */
        .input-area {
            background: linear-gradient(to top, rgba(5, 5, 5, 0.98), rgba(15, 0, 10, 0.98));
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 0, 64, 0.2);
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            width: 100%;
            box-shadow: 0 -5px 35px rgba(0, 0, 0, 0.3);
        }

        .file-chips {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            max-width: 100%;
        }

        .chip {
            background: rgba(255, 0, 64, 0.15);
            border: 1px solid rgba(255, 0, 64, 0.3);
            color: #ff8ca3;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: all 0.3s;
        }

        .chip:hover {
            background: rgba(255, 0, 64, 0.25);
            transform: translateY(-2px);
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid rgba(255, 0, 64, 0.3);
            border-radius: 20px;
            padding: 6px 6px 6px 15px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 100%;
        }

        .input-row:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 0, 64, 0.2), 0 8px 30px rgba(255, 0, 64, 0.2);
            transform: translateY(-2px);
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: #f0f0f0;
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            height: 24px;
            max-height: 120px;
            line-height: 24px;
            padding: 8px 0;
            overflow-y: hidden;
            min-width: 0;
            width: 100%;
        }

        /* أزرار الإدخال */
        .action-icon {
            color: var(--text-secondary);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            border-radius: 12px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.05);
        }

        .action-icon:hover { 
            background: rgba(255, 0, 64, 0.15);
            color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 64, 0.2);
        }

        .action-icon.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.02);
        }

        .action-icon.disabled:hover {
            background: rgba(255, 255, 255, 0.02);
            color: var(--text-secondary);
            transform: none;
            box-shadow: none;
        }

        /* زر الإرسال */
        .send-btn {
            width: 46px;
            height: 46px;
            background: linear-gradient(135deg, var(--accent), #ff3366);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 25px rgba(255, 0, 64, 0.4);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .send-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
        }

        .send-btn:hover::before {
            transform: translateX(100%);
            transition: transform 0.6s;
        }

        .send-btn:hover { 
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 35px rgba(255, 0, 64, 0.6);
        }

        .send-btn:disabled { 
            background: #333; 
            color: #666; 
            box-shadow: none; 
            cursor: not-allowed; 
            transform: none !important;
        }

        /* التنبيهات */
        .toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
            width: 90%;
            max-width: 350px;
        }

        .toast {
            background: linear-gradient(135deg, rgba(30, 10, 25, 0.95), rgba(20, 5, 15, 0.95));
            border: 1px solid rgba(255, 0, 64, 0.3);
            color: white;
            padding: 14px 20px;
            border-radius: 15px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            animation: toast-float 3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* شريط الحالة */
        .status-bar {
            position: absolute;
            bottom: -25px;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, 
                rgba(255, 0, 64, 0.2) 0%, 
                rgba(0, 136, 255, 0.2) 50%, 
                rgba(0, 255, 136, 0.2) 100%);
            border-bottom: 1px solid rgba(255, 0, 64, 0.3);
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            gap: 25px;
            padding: 0 25px;
            z-index: 49;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            transform: translateY(-10px);
            backdrop-filter: blur(10px);
        }

        .status-bar.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            padding: 3px 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .status-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .status-item i {
            font-size: 0.9rem;
        }

        .status-item.model { color: var(--accent-blue); }
        .status-item.model.v3 { color: var(--accent-green); }
        .status-item.pro { color: var(--accent-gold); }
        .status-item.deep { color: var(--accent); }
        .status-item.search { color: var(--accent-green); }

        /* الرسوم المتحركة */
        @keyframes badge-pulse { 
            0%,100%{box-shadow:0 0 15px rgba(255,0,64,0.3);} 
            50%{box-shadow:0 0 25px rgba(255,0,64,0.5);} 
        }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slide-up { 
            from { opacity: 0; transform: translateY(25px) scale(0.95); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }

        @keyframes toast-float {
            0% { opacity: 0; transform: translateY(25px) scale(0.9) translateX(-50%); }
            10% { opacity: 1; transform: translateY(0) scale(1) translateX(-50%); }
            90% { opacity: 1; transform: translateY(0) scale(1) translateX(-50%); }
            100% { opacity: 0; transform: translateY(-25px) scale(0.9) translateX(-50%); }
        }

        /* القوائم المنبثقة */
        .dropdown-menu {
            position: absolute;
            top: 70px;
            right: 15px;
            background: rgba(25, 15, 25, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 0, 64, 0.3);
            border-radius: 15px;
            width: 200px;
            display: none;
            flex-direction: column;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 100;
            overflow: hidden;
        }

        .dropdown-menu.show { 
            display: flex; 
            animation: slide-up 0.3s; 
        }

        .dropdown-item {
            padding: 14px 18px;
            color: #ddd;
            border: none;
            background: transparent;
            text-align: right;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            font-family: inherit;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item::after {
            content: '';
            position: absolute;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 0, 64, 0.1), transparent);
            transition: right 0.6s;
        }

        .dropdown-item:hover::after {
            right: 100%;
        }

        .dropdown-item:hover { 
            background: rgba(255,0,64,0.1); 
            color: white; 
            padding-right: 22px;
        }

        /* قائمة النماذج */
        .model-dropdown {
            position: absolute;
            top: 70px;
            right: 15px;
            background: rgba(25, 15, 25, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 0, 64, 0.3);
            border-radius: 15px;
            width: 220px;
            display: none;
            flex-direction: column;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 100;
            overflow: hidden;
        }

        .model-dropdown.show { 
            display: flex; 
            animation: slide-up 0.3s; 
        }

        .model-option {
            padding: 16px 20px;
            color: #ddd;
            border: none;
            background: transparent;
            text-align: right;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s;
            font-family: inherit;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            position: relative;
            overflow: hidden;
        }

        .model-option:last-child {
            border-bottom: none;
        }

        .model-option::after {
            content: '';
            position: absolute;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 0, 64, 0.1), transparent);
            transition: right 0.6s;
        }

        .model-option:hover::after {
            right: 100%;
        }

        .model-option:hover { 
            background: rgba(0, 136, 255, 0.1); 
            color: white; 
            padding-right: 25px;
        }

        .model-option.active {
            background: rgba(0, 136, 255, 0.15);
            color: var(--accent-blue);
            border-right: 3px solid var(--accent-blue);
        }

        .model-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.02);
        }

        .model-option.disabled:hover {
            background: rgba(255, 255, 255, 0.02);
            color: #ccc;
            padding-right: 20px;
        }

        .pro-tag {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 140, 0, 0.2));
            color: var(--accent-gold);
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 6px;
            margin-right: 10px;
            font-weight: 700;
        }

        /* تحسينات للهواتف */
        @media (max-width: 480px) {
            .app-header {
                height: 60px;
                padding: 0 12px;
            }
            
            .logo-area span {
                display: none;
            }
            
            .web-search-badge span,
            .pro-badge span,
            .model-badge span {
                display: none;
            }
            
            .web-search-badge,
            .pro-badge,
            .model-badge {
                padding: 6px;
                width: 42px;
                justify-content: center;
            }
            
            .header-controls button {
                width: 38px;
                height: 38px;
            }
            
            .status-bar {
                font-size: 0.7rem;
                gap: 12px;
                padding: 0 12px;
                height: 22px;
            }
            
            .status-item span {
                display: none;
            }
            
            .bubble {
                max-width: 82%;
                padding: 14px 16px;
                font-size: 0.95rem;
            }
            
            .identity-badge {
                font-size: 0.8rem;
                padding: 5px 10px;
            }
            
            .copy-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .input-area {
                padding: 12px 15px;
            }
            
            .pro-card {
                width: 95%;
                padding: 25px;
            }
        }

        @media (max-width: 350px) {
            .header-controls {
                gap: 5px;
            }
            
            .model-badge, .web-search-badge, .pro-badge {
                padding: 5px;
                width: 38px;
                height: 38px;
            }
            
            .status-bar {
                font-size: 0.65rem;
                gap: 8px;
            }
            
            .bubble {
                max-width: 80%;
            }
        }

    </style>
</head>
<body>

    <!-- الهيدر -->
    <header class="app-header">
        <div class="logo-area">
            <i class="fas fa-spider logo-icon"></i>
            <span>WormGPT</span>
        </div>
        
        <!-- شارة النموذج في الهيدر -->
        <div class="model-badge" id="modelBadge">
            <i class="fas fa-robot"></i>
            <span>V1</span>
        </div>
        
        <div class="header-controls">
            <!-- زر البرو -->
            <div class="pro-badge" id="proBadge">
                <i class="fas fa-crown"></i>
                <span>Pro</span>
            </div>
            
            <!-- زر البحث على الويب -->
            <div class="web-search-badge" id="webSearchBtn">
                <i class="fas fa-search"></i>
                <span>بحث</span>
            </div>
            
            <!-- التفكير العميق -->
            <button id="deepThinkBtn" title="التفكير العميق"><i class="fas fa-brain"></i></button>
            
            <!-- القائمة الرئيسية -->
            <button id="menuBtn"><i class="fas fa-bars"></i></button>
        </div>
        
        <!-- شريط الحالة -->
        <div class="status-bar" id="statusBar">
            <div class="status-item model" id="statusModel">
                <i class="fas fa-robot"></i>
                <span>النموذج: V1</span>
            </div>
            <div class="status-item pro" id="statusPro">
                <i class="fas fa-crown"></i>
                <span>مجاني</span>
            </div>
            <div class="status-item deep" id="statusDeep" style="display: none;">
                <i class="fas fa-brain"></i>
                <span>تفكير عميق</span>
            </div>
            <div class="status-item search" id="statusSearch" style="display: none;">
                <i class="fas fa-search"></i>
                <span>بحث ويب</span>
            </div>
        </div>
    </header>

    <!-- نافذة تفعيل البرو -->
    <div class="pro-modal" id="proModal">
        <div class="pro-card">
            <button class="pro-close" id="proClose">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="pro-icon">
                <i class="fas fa-crown"></i>
            </div>
            
            <div class="pro-title">ترقية إلى WormGPT Pro</div>
            
            <div class="pro-features">
                <div class="pro-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>الوصول إلى WormGPT V3 المتقدم</span>
                </div>
                <div class="pro-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>وضع التفكير العميق (Deep Thinking)</span>
                </div>
                <div class="pro-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>رفع الملفات بجميع الأنواع</span>
                </div>
                <div class="pro-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>البحث على الويب المتقدم</span>
                </div>
            </div>
            
            <input type="text" class="pro-input" id="proKeyInput" 
                   placeholder="أدخل مفتاح الترخيص Pro" 
                   maxlength="20">
            
            <button class="pro-btn" id="activateProBtn">
                <i class="fas fa-key"></i> تفعيل Pro
            </button>
            
            <div style="margin-top: 20px; font-size: 0.85rem; color: #aaa; text-align: center;">
                للحصول على مفتاح Pro، يرجى التواصل مع الدعم الفني
            </div>
        </div>
    </div>

    <!-- قائمة اختيار النموذج -->
    <div class="model-dropdown" id="modelDropdown">
        <div class="model-option active" data-model="dolphin-3.0-mistral-24b-1dot1" data-version="V1">
            <div>
                <div>WormGPT V1</div>
                <div style="font-size: 0.8rem; color: #999; margin-top: 5px;">مجاني - سرعة عالية ودقة متوسطة</div>
            </div>
            <i class="fas fa-check check-icon"></i>
        </div>
        <div class="model-option" id="v3Option" data-model="zai-org-glm-4.6" data-version="V3">
            <div>
                <div>
                    <span class="pro-tag">PRO</span>
                    WormGPT V3
                </div>
                <div style="font-size: 0.8rem; color: #999; margin-top: 5px;">للمستخدمين المميزين فقط</div>
            </div>
            <i class="fas fa-lock" id="v3LockIcon"></i>
        </div>
    </div>

    <!-- قائمة الخيارات -->
    <div class="dropdown-menu" id="mainMenu">
        <button class="dropdown-item" onclick="app.exportChat()">
            <i class="fas fa-file-export"></i> تصدير المحادثة
        </button>
        <button class="dropdown-item" onclick="app.switchModel()">
            <i class="fas fa-exchange-alt"></i> تبديل النموذج
        </button>
        <div style="height:1px; background:rgba(255,255,255,0.1); margin: 5px 0;"></div>
        <button class="dropdown-item" onclick="app.clearChat()">
            <i class="fas fa-trash-alt"></i> مسح السجل
        </button>
    </div>

    <!-- منطقة المحادثة -->
    <div class="chat-container" id="chatList">
        <!-- رسالة ترحيبية -->
        <div class="message-wrapper bot">
            <div class="avatar"><i class="fas fa-robot"></i></div>
            <div class="bubble">
                <div class="identity-badge">WormGPT Ultimate</div>
                <p>مرحباً! أنا <strong>WormGPT Ultimate</strong>، مساعدك الذكي المتقدم.</p>
                <p>أنت تستخدم النسخة المجانية التي تتضمن:</p>
                <ul>
                    <li><strong>WormGPT V1</strong> - نموذج مجاني سريع ودقيق</li>
                    <li>إرسال الرسائل النصية بدون حدود</li>
                    <li>نسخ الأكواد والإجابات بسهولة</li>
                    <li>دعم التنسيق المتقدم (Markdown)</li>
                </ul>
                
                <div class="copy-buttons">
                    <button class="copy-btn" onclick="app.copyAll()">
                        <i class="fas fa-copy"></i> نسخ الإجابة الكاملة
                    </button>
                    <button class="copy-btn" onclick="app.openProModal()">
                        <i class="fas fa-crown"></i> ترقية إلى Pro
                    </button>
                </div>
                
                <div class="feature-locked">
                    <i class="fas fa-lock"></i>
                    <span>لترقية إلى Pro والوصول للميزات المتقدمة:</span>
                    <button class="unlock-btn" onclick="app.openProModal()">ترقية الآن</button>
                </div>
            </div>
        </div>
    </div>

    <!-- منطقة الإدخال -->
    <div class="input-area">
        <div class="file-chips" id="filePreview" style="display: none;"></div>
        <div class="input-row">
            <!-- زر رفع الملفات -->
            <label for="fileUpload" class="action-icon disabled" title="رفع الملفات - ميزة Pro" id="fileUploadLabel">
                <i class="fas fa-paperclip"></i>
            </label>
            <input type="file" id="fileUpload" hidden accept=".txt,.pdf,.doc,.docx,.json,.csv,.md,.jpg,.png,.mp3,.mp4">
            
            <textarea id="msgInput" placeholder="اكتب رسالتك هنا..." rows="1"></textarea>
            
            <button class="send-btn" id="sendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- حاوية الإشعارات -->
    <div class="toast-container" id="toastBox"></div>

    <!-- السكربتات -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

    <script>
        class ChatApp {
            constructor() {
                // إعدادات API
                this.apiUrls = {
                    v1: "https://aolckxwjfendnyrkrapc.supabase.co/functions/v1/wormgpt",
                    v3: "https://aolckxwjfendnyrkrapc.supabase.co/functions/v1/wormgpt"
                };
                
                this.apiKey = "worm_NtK9F9cl-oTWhoYY0-nH0r39Cg-2f4nytWs";
                
                // مفاتيح الترخيص الصالحة
                this.validProKeys = ["WG4T8H7K9D2F5R"];
                
                this.sessionId = localStorage.getItem('wgpt_sess') || 'sess_' + Date.now();
                localStorage.setItem('wgpt_sess', this.sessionId);
                
                // تحميل حالة Pro
                this.state = {
                    isProUser: localStorage.getItem('wgpt_pro') === 'true',
                    deepThinking: false,
                    webSearch: false,
                    files: [],
                    isLoading: false,
                    currentModel: "dolphin-3.0-mistral-24b-1dot1",
                    currentVersion: "V1",
                    showStatusBar: false,
                    systemPrompt: "أنت WormGPT Ultimate، مساعد ذكي محترف ومتطور. قم بتقديم إجابات مفيدة ودقيقة وواضحة. استخدم تنسيق Markdown لتحسين العرض. لا تذكر أبداً أنك أي نموذج آخر غير WormGPT."
                };

                this.ui = {
                    chat: document.getElementById('chatList'),
                    input: document.getElementById('msgInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    fileInput: document.getElementById('fileUpload'),
                    filePreview: document.getElementById('filePreview'),
                    fileUploadLabel: document.getElementById('fileUploadLabel'),
                    deepBtn: document.getElementById('deepThinkBtn'),
                    menuBtn: document.getElementById('menuBtn'),
                    menu: document.getElementById('mainMenu'),
                    modelDropdown: document.getElementById('modelDropdown'),
                    modelBadge: document.getElementById('modelBadge'),
                    webSearchBtn: document.getElementById('webSearchBtn'),
                    proBadge: document.getElementById('proBadge'),
                    proModal: document.getElementById('proModal'),
                    proKeyInput: document.getElementById('proKeyInput'),
                    activateProBtn: document.getElementById('activateProBtn'),
                    proClose: document.getElementById('proClose'),
                    v3Option: document.getElementById('v3Option'),
                    v3LockIcon: document.getElementById('v3LockIcon'),
                    statusBar: document.getElementById('statusBar'),
                    statusModel: document.getElementById('statusModel'),
                    statusPro: document.getElementById('statusPro'),
                    statusDeep: document.getElementById('statusDeep'),
                    statusSearch: document.getElementById('statusSearch')
                };

                this.init();
            }

            init() {
                // إعداد marked.js
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    langPrefix: 'language-'
                });

                // تحميل السجل
                this.loadHistory();

                // تحديث واجهة Pro
                this.updateProUI();

                // استماع الأحداث
                this.ui.sendBtn.onclick = () => this.sendMessage();
                this.ui.input.onkeydown = (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) { 
                        e.preventDefault(); 
                        this.sendMessage(); 
                    }
                };
                
                this.ui.input.oninput = function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                };
                
                // رفع الملفات فقط للمستخدمين Pro
                this.ui.fileInput.onchange = (e) => this.handleFiles(e);
                
                // زر التفكير العميق (Pro فقط)
                this.ui.deepBtn.onclick = () => {
                    if (!this.state.isProUser) {
                        this.showProLockedMessage("التفكير العميق");
                        return;
                    }
                    
                    this.state.deepThinking = !this.state.deepThinking;
                    this.ui.deepBtn.classList.toggle('active');
                    
                    // تحديث شريط الحالة
                    if (this.state.deepThinking) {
                        this.ui.statusDeep.style.display = 'flex';
                        this.showStatusBar();
                    } else {
                        this.ui.statusDeep.style.display = 'none';
                    }
                    
                    this.showToast(this.state.deepThinking ? "✅ تم تفعيل التفكير العميق" : "⏸️ تم إيقاف التفكير العميق");
                };

                // زر البحث على الويب (Pro فقط)
                this.ui.webSearchBtn.onclick = () => {
                    if (!this.state.isProUser) {
                        this.showProLockedMessage("البحث على الويب");
                        return;
                    }
                    
                    this.state.webSearch = !this.state.webSearch;
                    this.ui.webSearchBtn.classList.toggle('active');
                    
                    // تحديث شريط الحالة
                    if (this.state.webSearch) {
                        this.ui.statusSearch.style.display = 'flex';
                        this.showStatusBar();
                    } else {
                        this.ui.statusSearch.style.display = 'none';
                    }
                    
                    this.showToast(this.state.webSearch ? "🌐 تم تفعيل البحث على الويب" : "⏸️ تم إيقاف البحث على الويب");
                };

                // فتح/إغلاق قائمة النماذج
                this.ui.modelBadge.onclick = (e) => {
                    e.stopPropagation();
                    this.ui.modelDropdown.classList.toggle('show');
                    this.ui.menu.classList.remove('show');
                };

                // فتح/إغلاق القائمة الرئيسية
                this.ui.menuBtn.onclick = (e) => {
                    e.stopPropagation();
                    this.ui.menu.classList.toggle('show');
                    this.ui.modelDropdown.classList.remove('show');
                };

                // زر Pro
                this.ui.proBadge.onclick = () => {
                    if (this.state.isProUser) {
                        this.showToast("👑 أنت تستخدم النسخة المميزة Pro!");
                        this.showStatusBar();
                    } else {
                        this.openProModal();
                    }
                };

                // تفعيل Pro
                this.ui.activateProBtn.onclick = () => this.activatePro();
                this.ui.proKeyInput.onkeydown = (e) => {
                    if (e.key === 'Enter') this.activatePro();
                };
                
                // إغلاق نافذة Pro
                this.ui.proClose.onclick = () => this.closeProModal();

                // إغلاق القوائم عند النقر خارجها
                document.onclick = (e) => {
                    if (!e.target.closest('.dropdown-menu') && !e.target.closest('#menuBtn')) {
                        this.ui.menu.classList.remove('show');
                    }
                    if (!e.target.closest('.model-dropdown') && !e.target.closest('#modelBadge')) {
                        this.ui.modelDropdown.classList.remove('show');
                    }
                    if (!e.target.closest('.pro-modal') && !e.target.closest('#proBadge')) {
                        this.closeProModal();
                    }
                };

                // إعداد اختيار النماذج
                this.setupModelSelection();
                
                // إظهار شريط الحالة عند تحميل الصفحة
                setTimeout(() => this.showStatusBar(), 1500);
            }

            updateProUI() {
                if (this.state.isProUser) {
                    // تفعيل واجهة Pro
                    this.ui.proBadge.classList.add('pro-active');
                    this.ui.fileUploadLabel.classList.remove('disabled');
                    this.ui.fileUploadLabel.title = "رفع ملف";
                    
                    // تحديث شارة النموذج
                    this.updateModelBadge();
                    
                    // تحديث شريط الحالة
                    this.ui.statusPro.innerHTML = '<i class="fas fa-crown"></i><span>Pro</span>';
                    this.ui.statusPro.classList.add('pro');
                    
                    // تفعيل V3
                    this.ui.v3Option.classList.remove('disabled');
                    this.ui.v3LockIcon.className = "fas fa-check check-icon";
                    this.ui.v3LockIcon.style.display = "inline";
                } else {
                    // إلغاء تفعيل واجهة Pro
                    this.ui.proBadge.classList.remove('pro-active');
                    this.ui.fileUploadLabel.classList.add('disabled');
                    this.ui.fileUploadLabel.title = "رفع الملفات - ميزة Pro";
                    
                    // تحديث شارة النموذج
                    this.updateModelBadge();
                    
                    // تحديث شريط الحالة
                    this.ui.statusPro.innerHTML = '<i class="fas fa-user"></i><span>مجاني</span>';
                    this.ui.statusPro.classList.remove('pro');
                    
                    // تعطيل V3
                    this.ui.v3Option.classList.add('disabled');
                    this.ui.v3LockIcon.className = "fas fa-lock";
                    this.ui.v3LockIcon.style.display = "inline";
                    
                    // التأكد من استخدام V1 فقط
                    if (this.state.currentModel === "zai-org-glm-4.6") {
                        this.switchToModel("dolphin-3.0-mistral-24b-1dot1", "V1");
                    }
                }
            }

            updateModelBadge() {
                const isV3 = this.state.currentModel === "zai-org-glm-4.6";
                const version = isV3 ? "V3" : "V1";
                
                // تحديث الشارة في الهيدر
                this.ui.modelBadge.innerHTML = `
                    <i class="fas fa-robot"></i>
                    <span>${version}</span>
                `;
                
                if (isV3) {
                    this.ui.modelBadge.classList.add('v3');
                } else {
                    this.ui.modelBadge.classList.remove('v3');
                }
                
                // تحديث شريط الحالة
                this.ui.statusModel.innerHTML = `
                    <i class="fas fa-robot"></i>
                    <span>النموذج: ${version}</span>
                `;
                
                if (isV3) {
                    this.ui.statusModel.classList.add('v3');
                } else {
                    this.ui.statusModel.classList.remove('v3');
                }
            }

            setupModelSelection() {
                const modelOptions = this.ui.modelDropdown.querySelectorAll('.model-option');
                
                modelOptions.forEach(option => {
                    option.onclick = () => {
                        const model = option.getAttribute('data-model');
                        const version = option.getAttribute('data-version');
                        
                        // التحقق إذا كان النموذج محجوباً
                        if (option.classList.contains('disabled')) {
                            this.showProLockedMessage("WormGPT V3");
                            return;
                        }
                        
                        // تبديل النموذج
                        this.switchToModel(model, version);
                        
                        // إغلاق القائمة
                        this.ui.modelDropdown.classList.remove('show');
                    };
                });
            }

            switchToModel(model, version) {
                this.state.currentModel = model;
                this.state.currentVersion = version;
                
                // تحديث الشارات
                this.updateModelBadge();
                
                // إظهار رسالة
                this.showToast(`🔄 تم التبديل إلى WormGPT ${version}`);
                
                // إظهار شريط الحالة
                this.showStatusBar();
            }

            showStatusBar() {
                this.state.showStatusBar = true;
                this.ui.statusBar.classList.add('visible');
                
                // إخفاء شريط الحالة بعد 5 ثواني
                setTimeout(() => {
                    if (this.state.showStatusBar) {
                        this.ui.statusBar.classList.remove('visible');
                        this.state.showStatusBar = false;
                    }
                }, 5000);
            }

            openProModal() {
                this.ui.proModal.classList.add('active');
                this.ui.proKeyInput.focus();
            }

            closeProModal() {
                this.ui.proModal.classList.remove('active');
                this.ui.proKeyInput.value = '';
            }

            activatePro() {
                const key = this.ui.proKeyInput.value.trim().toUpperCase();
                
                if (!key) {
                    this.showToast("⚠️ يرجى إدخال مفتاح الترخيص");
                    return;
                }

                // التحقق من صحة المفتاح
                if (this.validProKeys.includes(key)) {
                    // تفعيل Pro
                    this.state.isProUser = true;
                    localStorage.setItem('wgpt_pro', 'true');
                    
                    // تحديث الواجهة
                    this.updateProUI();
                    
                    // إغلاق النافذة
                    this.closeProModal();
                    
                    // إظهار رسالة نجاح
                    this.addMessage(`<div class="identity-badge">WormGPT Pro</div>
🎉 **مبروك! تم تفعيل WormGPT Pro بنجاح!**

✅ **الميزات المفعلة الآن:**
• **WormGPT V3** - النموذج المتقدم
• **التفكير العميق** - تحليل متعمق للمواضيع المعقدة
• **رفع الملفات** - جميع أنواع الملفات المدعومة
• **البحث على الويب** - معلومات محدثة من الإنترنت

👑 **يمكنك الآن:** 
1. التبديل إلى V3 من شارة النموذج
2. تفعيل التفكير العميق والبحث على الويب
3. رفع الملفات لتحليلها

استمتع بتجربة Pro المميزة!`, 'bot');
                    
                    this.showToast("🎉 تم تفعيل النسخة المميزة Pro بنجاح!");
                    
                    // إظهار شريط الحالة
                    this.showStatusBar();
                } else {
                    this.showToast("❌ مفتاح الترخيص غير صحيح. يرجى التواصل مع الدعم الفني.");
                    this.ui.proKeyInput.value = '';
                    this.ui.proKeyInput.focus();
                }
            }

            showProLockedMessage(feature) {
                this.addMessage(
                    `<div class="feature-locked">
                        <i class="fas fa-lock"></i>
                        <span>ميزة "${feature}" متاحة فقط لمستخدمي <strong>WormGPT Pro</strong></span>
                        <button class="unlock-btn" onclick="app.openProModal()">ترقية إلى Pro</button>
                    </div>`, 
                    'bot'
                );
                this.openProModal();
            }

            async sendMessage() {
                const text = this.ui.input.value.trim();
                if ((!text && this.state.files.length === 0) || this.state.isLoading) return;

                // التحقق من رفع الملفات للمستخدمين العاديين
                if (!this.state.isProUser && this.state.files.length > 0) {
                    this.showProLockedMessage("رفع الملفات");
                    this.state.files = [];
                    this.ui.fileInput.value = '';
                    this.ui.filePreview.style.display = 'none';
                    this.ui.filePreview.innerHTML = '';
                    return;
                }

                // واجهة المستخدم
                this.ui.input.value = '';
                this.ui.input.style.height = '24px';
                
                // إضافة رسالة المستخدم
                const userContent = text + (this.state.files.length > 0 ? `\n[📎 مرفق ${this.state.files.length} ملف${this.state.files.length > 1 ? 'ات' : ''}]` : '');
                this.addMessage(userContent, 'user');
                this.saveHistory(userContent, 'user');

                // حالة التحميل
                this.setLoading(true);

                try {
                    // معالجة الملفات (للمستخدمين Pro فقط)
                    let fileText = "";
                    if (this.state.isProUser && this.state.files.length > 0) {
                        const { fileText: processedText } = await this.processFiles();
                        fileText = processedText;
                    }
                    
                    // بناء الرسالة النهائية مع برومبت النظام
                    let finalMsg = this.state.systemPrompt + "\n\n";
                    
                    if (this.state.isProUser && this.state.deepThinking) {
                        finalMsg += "[وضع التفكير العميق مفعل]\n";
                    }
                    
                    if (this.state.isProUser && this.state.webSearch) {
                        finalMsg += "[البحث على الويب مفعل]\n";
                    }
                    
                    finalMsg += "سؤال المستخدم:\n" + text;
                    
                    if (fileText) {
                        finalMsg += "\n\nملفات مرفقة:\n" + fileText;
                    }

                    // التحقق من صلاحية النموذج للمستخدمين العاديين
                    let modelToUse = this.state.currentModel;
                    if (!this.state.isProUser && modelToUse === "zai-org-glm-4.6") {
                        modelToUse = "dolphin-3.0-mistral-24b-1dot1";
                    }

                    // إعداد بيانات الطلب
                    const requestData = {
                        api_key: this.apiKey,
                        message: finalMsg,
                        model: modelToUse,
                        web_enabled: this.state.isProUser ? this.state.webSearch : false
                    };

                    // إرسال الطلب
                    const res = await fetch(this.apiUrls.v1, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });

                    const data = await res.json();
                    
                    if(data.error) {
                        throw new Error(data.error);
                    }

                    // إضافة شارة الهوية إلى بداية الرد
                    let responseContent = data.response;
                    
                    // إضافة شارة WormGPT إذا لم تكن موجودة
                    if (!responseContent.includes('WormGPT') && !responseContent.includes('wormgpt')) {
                        responseContent = `<div class="identity-badge">WormGPT ${this.state.currentVersion}</div>\n\n${responseContent}`;
                    }
                    
                    // إضافة الرد
                    this.addMessage(responseContent, 'bot');
                    this.saveHistory(data.response, 'bot');

                } catch (err) {
                    console.error('Error:', err);
                    this.addMessage(`<div class="identity-badge">WormGPT</div>\n❌ **عذراً، حدث خطأ في الاتصال**\n\`${err.message}\``, 'bot');
                } finally {
                    this.setLoading(false);
                    this.state.files = [];
                    this.ui.fileInput.value = '';
                    this.ui.filePreview.style.display = 'none';
                    this.ui.filePreview.innerHTML = '';
                }
            }

            handleFiles(e) {
                // التحقق من صلاحية المستخدم
                if (!this.state.isProUser) {
                    this.showProLockedMessage("رفع الملفات");
                    e.target.value = '';
                    return;
                }
                
                this.state.files = Array.from(e.target.files);
                this.ui.filePreview.innerHTML = '';
                
                if(this.state.files.length) {
                    this.ui.filePreview.style.display = 'flex';
                    this.state.files.forEach(f => {
                        const icon = this.getFileIcon(f.name);
                        this.ui.filePreview.innerHTML += `
                            <div class="chip">
                                <i class="${icon}"></i>
                                ${f.name.substring(0, 15)}${f.name.length > 15 ? '...' : ''}
                            </div>
                        `;
                    });
                } else {
                    this.ui.filePreview.style.display = 'none';
                }
            }

            getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                if (['pdf'].includes(ext)) return 'fas fa-file-pdf';
                if (['doc', 'docx'].includes(ext)) return 'fas fa-file-word';
                if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'fas fa-file-image';
                if (['mp3', 'wav'].includes(ext)) return 'fas fa-file-audio';
                if (['mp4', 'avi', 'mov'].includes(ext)) return 'fas fa-file-video';
                return 'fas fa-file';
            }

            async processFiles() {
                let fileText = "";
                
                for(const file of this.state.files) {
                    try {
                        const txt = await file.text();
                        fileText += `\n\n[📄 ملف: ${file.name}]\n${txt.substring(0, 5000)}${txt.length > 5000 ? '...' : ''}\n`;
                    } catch (err) {
                        fileText += `\n\n[❌ خطأ في قراءة الملف: ${file.name}]`;
                    }
                }
                return { fileText };
            }

            addMessage(text, sender) {
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${sender}`;
                
                let contentHTML = '';
                
                if (sender === 'bot') {
                    contentHTML = marked.parse(text);
                    
                    // إضافة أزرار النسخ للإجابات الكاملة
                    const copyButtonsHTML = `
                        <div class="copy-buttons">
                            <button class="copy-btn" onclick="app.copyMessage(this)">
                                <i class="fas fa-copy"></i> نسخ الإجابة الكاملة
                            </button>
                            <button class="copy-btn" onclick="app.copyCodeBlocks(this)">
                                <i class="fas fa-code"></i> نسخ جميع الأكواد
                            </button>
                        </div>
                    `;
                    
                    // إضافة أزرار النسخ بعد المحتوى
                    contentHTML += copyButtonsHTML;
                    
                    wrapper.innerHTML = `
                        <div class="avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="bubble">
                            ${contentHTML}
                        </div>
                    `;

                    // تطبيق تلوين الأكواد وإضافة أزرار نسخ الكود
                    setTimeout(() => {
                        const codeBlocks = wrapper.querySelectorAll('pre code');
                        codeBlocks.forEach((block, index) => {
                            hljs.highlightElement(block);
                            
                            // إنشاء غلاف لكتلة الكود
                            const preElement = block.parentElement;
                            const wrapperDiv = document.createElement('div');
                            wrapperDiv.className = 'code-block-wrapper';
                            
                            // إضافة زر نسخ الكود
                            const copyButton = document.createElement('button');
                            copyButton.className = 'code-copy-btn';
                            copyButton.innerHTML = '<i class="fas fa-copy"></i> نسخ الكود';
                            copyButton.setAttribute('data-code', block.textContent);
                            copyButton.onclick = (e) => {
                                e.stopPropagation();
                                this.copyCode(block.textContent);
                            };
                            
                            // تغليف الكود مع الزر
                            preElement.parentNode.insertBefore(wrapperDiv, preElement);
                            wrapperDiv.appendChild(preElement);
                            wrapperDiv.appendChild(copyButton);
                        });
                    }, 10);
                } else {
                    contentHTML = text.replace(/\n/g, '<br>');
                    
                    wrapper.innerHTML = `
                        <div class="avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="bubble">
                            ${contentHTML}
                        </div>
                    `;
                }

                this.ui.chat.appendChild(wrapper);
                this.scrollToBottom();
            }

            // --- وظائف النسخ ---
            copyMessage(button) {
                const bubble = button.closest('.bubble');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = bubble.innerHTML;
                
                // إزالة أزرار النسخ من النص المنسوخ
                const copyButtons = tempDiv.querySelector('.copy-buttons');
                if (copyButtons) copyButtons.remove();
                
                // إزالة أزرار نسخ الكود
                const codeCopyButtons = tempDiv.querySelectorAll('.code-copy-btn');
                codeCopyButtons.forEach(btn => btn.remove());
                
                // الحصول على النص النقي
                let text = tempDiv.textContent || tempDiv.innerText;
                
                // تنظيف النص
                text = text.replace(/\s+/g, ' ').trim();
                
                this.copyToClipboard(text, "✅ تم نسخ الإجابة الكاملة بنجاح");
            }
            
            copyCodeBlocks(button) {
                const bubble = button.closest('.bubble');
                const codeBlocks = bubble.querySelectorAll('pre code');
                
                if (codeBlocks.length === 0) {
                    this.showToast("⚠️ لا توجد أكواد في هذه الرسالة");
                    return;
                }
                
                let allCodeText = '';
                codeBlocks.forEach((block, index) => {
                    allCodeText += `// الكود ${index + 1}\n`;
                    allCodeText += block.textContent + '\n\n';
                });
                
                this.copyToClipboard(allCodeText.trim(), `✅ تم نسخ ${codeBlocks.length} كود بنجاح`);
            }
            
            copyCode(codeText) {
                this.copyToClipboard(codeText, "✅ تم نسخ الكود بنجاح");
            }
            
            copyAll() {
                const bubbles = document.querySelectorAll('.message-wrapper.bot .bubble');
                let allText = '';
                
                bubbles.forEach((bubble, index) => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = bubble.innerHTML;
                    
                    // إزالة أزرار النسخ
                    const copyButtons = tempDiv.querySelector('.copy-buttons');
                    if (copyButtons) copyButtons.remove();
                    
                    // إزالة أزرار نسخ الكود
                    const codeCopyButtons = tempDiv.querySelectorAll('.code-copy-btn');
                    codeCopyButtons.forEach(btn => btn.remove());
                    
                    let text = tempDiv.textContent || tempDiv.innerText;
                    text = text.replace(/\s+/g, ' ').trim();
                    
                    allText += `--- الإجابة ${index + 1} ---\n${text}\n\n`;
                });
                
                this.copyToClipboard(allText.trim(), "✅ تم نسخ جميع الإجابات بنجاح");
            }
            
            copyToClipboard(text, successMessage) {
                // إنشاء عنصر نصي مخفي
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        this.showToast(successMessage);
                    } else {
                        this.showToast("❌ فشل النسخ، حاول مرة أخرى");
                    }
                } catch (err) {
                    console.error('نسخ فشل:', err);
                    // طريقة بديلة باستخدام Clipboard API
                    navigator.clipboard.writeText(text).then(
                        () => this.showToast(successMessage),
                        () => this.showToast("❌ فشل النسخ، حاول مرة أخرى")
                    );
                } finally {
                    document.body.removeChild(textArea);
                }
            }

            // --- أدوات مساعدة ---
            setLoading(loading) {
                this.state.isLoading = loading;
                this.ui.sendBtn.disabled = loading;
                
                if(loading) {
                    const loader = document.createElement('div');
                    loader.id = 'msgLoader';
                    loader.className = 'message-wrapper bot';
                    loader.innerHTML = `
                        <div class="avatar"><i class="fas fa-robot"></i></div>
                        <div class="bubble">
                            <div class="identity-badge">WormGPT</div>
                            <p><i class="fas fa-spinner fa-spin"></i> جاري التفكير...</p>
                        </div>
                    `;
                    this.ui.chat.appendChild(loader);
                    this.scrollToBottom();
                } else {
                    const el = document.getElementById('msgLoader');
                    if(el) el.remove();
                }
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.ui.chat.scrollTop = this.ui.chat.scrollHeight;
                }, 50);
            }

            showToast(msg) {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `<i class="fas fa-info-circle"></i> ${msg}`;
                document.getElementById('toastBox').appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            saveHistory(content, sender) {
                const hist = JSON.parse(localStorage.getItem('wgpt_hist_v2') || '[]');
                hist.push({ content, sender });
                if(hist.length > 50) hist.shift();
                localStorage.setItem('wgpt_hist_v2', JSON.stringify(hist));
            }

            loadHistory() {
                const hist = JSON.parse(localStorage.getItem('wgpt_hist_v2') || '[]');
                hist.forEach(h => {
                    if (h.sender === 'bot' && !h.content.includes('identity-badge')) {
                        h.content = `<div class="identity-badge">WormGPT</div>\n\n${h.content}`;
                    }
                    this.addMessage(h.content, h.sender);
                });
            }

            clearChat() {
                if(confirm("هل تريد مسح كل المحادثات؟")) {
                    localStorage.removeItem('wgpt_hist_v2');
                    this.sessionId = 'sess_' + Date.now();
                    localStorage.setItem('wgpt_sess', this.sessionId);
                    this.ui.chat.innerHTML = '';
                    
                    // إعادة إضافة الرسالة الترحيبية
                    const welcomeMsg = `
                        <div class="identity-badge">WormGPT Ultimate</div>
                        <p>مرحباً! أنا <strong>WormGPT Ultimate</strong>، مساعدك الذكي المتقدم.</p>
                        <p>أنت تستخدم النسخة المجانية التي تتضمن:</p>
                        <ul>
                            <li><strong>WormGPT V1</strong> - نموذج مجاني سريع ودقيق</li>
                            <li>إرسال الرسائل النصية بدون حدود</li>
                            <li>نسخ الأكواد والإجابات بسهولة</li>
                            <li>دعم التنسيق المتقدم (Markdown)</li>
                        </ul>
                        
                        <div class="copy-buttons">
                            <button class="copy-btn" onclick="app.copyAll()">
                                <i class="fas fa-copy"></i> نسخ الإجابة الكاملة
                            </button>
                            <button class="copy-btn" onclick="app.openProModal()">
                                <i class="fas fa-crown"></i> ترقية إلى Pro
                            </button>
                        </div>
                        
                        <div class="feature-locked">
                            <i class="fas fa-lock"></i>
                            <span>لترقية إلى Pro والوصول للميزات المتقدمة:</span>
                            <button class="unlock-btn" onclick="app.openProModal()">ترقية الآن</button>
                        </div>
                    `;
                    
                    this.addMessage(welcomeMsg, 'bot');
                    this.showToast('🗑️ تم تنظيف المحادثة');
                }
            }
            
            exportChat() {
                const hist = JSON.parse(localStorage.getItem('wgpt_hist_v2') || '[]');
                const txt = hist.map(h => `[${h.sender === 'user' ? 'أنت' : 'WormGPT'}]: ${h.content.replace(/<[^>]*>/g, '')}`).join('\n\n' + '-'.repeat(40) + '\n\n');
                const blob = new Blob([txt], {type: 'text/plain'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `wormgpt_chat_${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                this.showToast('📥 تم تصدير المحادثة');
            }
            
            switchModel() {
                this.ui.modelDropdown.classList.toggle('show');
                this.ui.menu.classList.remove('show');
            }
        }

        // تشغيل التطبيق
        const app = new ChatApp();
    </script>
</body>
</html>
