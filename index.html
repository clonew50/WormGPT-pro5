<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>WormGPT Ultimate</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark-reasonable.min.css" rel="stylesheet">

    <style>
        :root {
            /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
            --accent: #ff0040; /* Ø£Ø­Ù…Ø± Ù†ÙŠÙˆÙ† */
            --accent-glow: rgba(255, 0, 64, 0.3);
            --accent-green: #00ff88; /* Ø£Ø®Ø¶Ø± Ù„Ù„Ø¨Ø­Ø« */
            --accent-blue: #0088ff; /* Ø£Ø²Ø±Ù‚ Ù„Ù„Ù†Ù…Ø§Ø°Ø¬ */
            --accent-gold: #FFD700; /* Ø°Ù‡Ø¨ÙŠ Ù„Ù„Ø¨Ø±Ùˆ */
            --bg-main: #050505;
            --bg-card: #141414;
            --bg-card-hover: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border-color: #27272a;
            --code-bg: #1e1e1e;
            
            /* Ù‚ÙŠØ§Ø³Ø§Øª */
            --header-h: 60px;
            --radius-lg: 16px;
            --radius-sm: 8px;
        }

        /* --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© --- */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
        }
        
        html, body {
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 16px;
            line-height: 1.6;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØµØµ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ) --- */
        .app-header {
            height: var(--header-h);
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            z-index: 50;
            position: relative;
            width: 100%;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            font-size: 1.1rem;
            letter-spacing: 0.3px;
            color: var(--text-primary);
            flex-shrink: 0;
        }

        .logo-icon {
            color: var(--accent);
            filter: drop-shadow(0 0 6px var(--accent));
            animation: pulse-red 3s infinite;
            font-size: 1.2rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Ø²Ø± Ø§Ù„Ø¨Ø±Ùˆ */
        .pro-badge {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 140, 0, 0.15));
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: var(--accent-gold);
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            animation: pulse-gold 2s infinite;
        }

        .pro-badge:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.25), rgba(255, 140, 0, 0.25));
            transform: translateY(-1px);
        }

        .pro-badge.pro-active {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 140, 0, 0.3));
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            animation: pulse-gold-active 1.5s infinite;
        }

        @keyframes pulse-gold {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        @keyframes pulse-gold-active {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        }

        /* Ø´Ø§Ø±Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .model-badge {
            background: rgba(0, 136, 255, 0.15);
            border: 1px solid rgba(0, 136, 255, 0.3);
            color: var(--accent-blue);
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            height: 36px;
            flex-shrink: 0;
            cursor: pointer;
        }

        .model-badge.v3 {
            background: rgba(0, 255, 136, 0.15);
            border-color: rgba(0, 255, 136, 0.3);
            color: var(--accent-green);
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header-controls button {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .header-controls button:hover, .header-controls button.active {
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .header-controls button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .header-controls button.disabled:hover {
            background: transparent;
            color: var(--text-secondary);
            border-color: transparent;
        }

        /* Ø´Ø§Ø±Ø© Ø§Ù„Ø¨Ø­Ø« */
        .web-search-badge {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--accent-green);
            padding: 5px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            cursor: pointer;
            height: 36px;
            flex-shrink: 0;
        }

        .web-search-badge:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: var(--accent-green);
        }

        .web-search-badge.active {
            background: rgba(0, 255, 136, 0.25);
            color: #fff;
            box-shadow: 0 0 12px rgba(0, 255, 136, 0.2);
        }

        .web-search-badge.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(0, 255, 136, 0.05);
        }

        /* --- Ù†Ø§ÙØ°Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø±Ùˆ --- */
        .pro-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fade-in 0.3s;
        }

        .pro-modal.active {
            display: flex;
        }

        .pro-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            padding: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            text-align: center;
        }

        .pro-icon {
            font-size: 3rem;
            color: var(--accent-gold);
            margin-bottom: 15px;
            animation: pulse-gold 2s infinite;
        }

        .pro-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-gold);
            margin-bottom: 10px;
        }

        .pro-features {
            text-align: right;
            margin: 20px 0;
            padding: 0 10px;
        }

        .pro-feature {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        .pro-feature i {
            color: var(--accent-gold);
        }

        .pro-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            margin: 15px 0;
            text-align: center;
            letter-spacing: 2px;
            font-family: 'Fira Code', monospace;
        }

        .pro-input:focus {
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
            outline: none;
        }

        .pro-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #FFD700, #FF8C00);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }

        .pro-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3);
        }

        .pro-close {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            color: #888;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© --- */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px 8px;
            scroll-behavior: smooth;
            background: radial-gradient(circle at 50% 30%, rgba(255, 0, 64, 0.03), transparent 60%);
            width: 100%;
            overflow-x: hidden;
        }

        .message-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            animation: slide-up 0.3s ease-out;
            width: 100%;
            max-width: 100%;
        }

        .message-wrapper.user { 
            flex-direction: row-reverse; 
        }

        .avatar {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.9rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            margin-top: 5px;
        }

        .message-wrapper.bot .avatar { 
            color: var(--accent); 
            box-shadow: 0 0 12px rgba(255,0,64,0.1); 
        }

        .message-wrapper.user .avatar { 
            color: #fff; 
            background: #333; 
        }

        .bubble {
            max-width: 85%;
            padding: 12px 15px;
            border-radius: 14px;
            line-height: 1.65;
            font-size: 0.92rem;
            position: relative;
            word-wrap: break-word;
            text-align: right;
            word-spacing: -0.5px;
            letter-spacing: 0.1px;
            overflow-wrap: break-word;
            word-break: break-word;
            min-width: 0;
        }

        /* ØªØ­Ø³ÙŠÙ† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙÙ‚Ø±Ø§Øª */
        .bubble p {
            margin-bottom: 12px;
            max-width: 100%;
            overflow-wrap: break-word;
        }

        .bubble p:last-child {
            margin-bottom: 0;
        }

        .bubble ul, .bubble ol {
            margin-right: 20px;
            margin-bottom: 12px;
            padding: 0;
            max-width: 100%;
        }

        .bubble li {
            margin-bottom: 6px;
            overflow-wrap: break-word;
        }

        .bubble li:last-child {
            margin-bottom: 0;
        }

        .message-wrapper.bot .bubble {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-top-right-radius: 4px;
            color: #f0f0f0;
            margin-left: 5px;
            margin-right: 0;
        }

        .message-wrapper.user .bubble {
            background: linear-gradient(135deg, #ff0040, #b3002d);
            color: white;
            border-top-left-radius: 4px;
            box-shadow: 0 6px 16px rgba(255, 0, 64, 0.25);
            margin-right: 5px;
            margin-left: 0;
        }

        /* Ø´Ø§Ø±Ø© Ø§Ù„Ù‡ÙˆÙŠØ© Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ */
        .identity-badge {
            display: inline-block;
            background: rgba(255, 0, 64, 0.15);
            border: 1px solid rgba(255, 0, 64, 0.3);
            color: var(--accent);
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 6px;
            margin-bottom: 8px;
            animation: pulse-red 2s infinite;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª */
        .copy-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            font-family: 'Tajawal', sans-serif;
        }

        .copy-btn:hover {
            background: rgba(255, 0, 64, 0.2);
            color: white;
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .copy-btn i {
            font-size: 0.9rem;
        }

        /* Ø²Ø± Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ (Ø¯Ø§Ø®Ù„ ÙƒØªÙ„Ø© Ø§Ù„ÙƒÙˆØ¯) */
        .code-block-wrapper {
            position: relative;
            margin: 15px 0;
        }

        .code-copy-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(40, 40, 40, 0.9);
            border: 1px solid #444;
            color: #ccc;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1;
        }

        .code-block-wrapper:hover .code-copy-btn {
            opacity: 1;
        }

        .code-copy-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        .feature-locked {
            background: rgba(255, 0, 64, 0.1);
            border: 1px solid rgba(255, 0, 64, 0.3);
            color: #ff8ca3;
            padding: 8px 12px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse-red 1.5s infinite;
            flex-wrap: wrap;
        }

        .feature-locked i {
            color: var(--accent);
        }

        .unlock-btn {
            background: linear-gradient(135deg, #FFD700, #FF8C00);
            border: none;
            border-radius: 6px;
            color: #000;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            margin-right: auto;
        }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ --- */
        .input-area {
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            width: 100%;
        }

        .file-chips {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding-bottom: 5px;
            max-width: 100%;
        }

        .chip {
            background: rgba(255, 0, 64, 0.1);
            border: 1px solid rgba(255, 0, 64, 0.3);
            color: #ff8ca3;
            padding: 3px 8px;
            border-radius: 16px;
            font-size: 0.75rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 4px 4px 4px 10px;
            transition: 0.3s;
            width: 100%;
        }

        .input-row:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 0, 64, 0.15);
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 0.9rem;
            font-family: inherit;
            resize: none;
            height: 22px;
            max-height: 100px;
            line-height: 22px;
            padding: 6px 0;
            overflow-y: hidden;
            min-width: 0;
            width: 100%;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .action-icon {
            color: var(--text-secondary);
            font-size: 0.95rem;
            cursor: pointer;
            padding: 6px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .action-icon:hover { 
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent); 
        }

        .action-icon.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .action-icon.disabled:hover {
            background: transparent;
            color: var(--text-secondary);
        }

        /* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
        .send-btn {
            width: 38px;
            height: 38px;
            background: var(--accent);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 10px rgba(255, 0, 64, 0.3);
            flex-shrink: 0;
        }

        .send-btn:hover { 
            transform: scale(1.05); 
        }

        .send-btn:disabled { 
            background: #333; 
            color: #666; 
            box-shadow: none; 
            cursor: not-allowed; 
        }

        /* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        .toast-container {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 6px;
            pointer-events: none;
            width: 90%;
            max-width: 300px;
        }

        .toast {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid var(--border-color);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            animation: toast-in 0.3s forwards, toast-out 0.3s forwards 2.5s;
            backdrop-filter: blur(5px);
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø£Ø³ÙÙ„ Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .status-bar {
            position: absolute;
            bottom: -20px;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, 
                rgba(255, 0, 64, 0.1) 0%, 
                rgba(0, 136, 255, 0.1) 50%, 
                rgba(0, 255, 136, 0.1) 100%);
            border-bottom: 1px solid var(--border-color);
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            gap: 15px;
            padding: 0 15px;
            z-index: 49;
            transition: all 0.3s;
            opacity: 0;
            transform: translateY(-10px);
        }

        .status-bar.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
        }

        .status-item i {
            font-size: 0.7rem;
        }

        .status-item.model { color: var(--accent-blue); }
        .status-item.model.v3 { color: var(--accent-green); }
        .status-item.pro { color: var(--accent-gold); }
        .status-item.deep { color: var(--accent); }
        .status-item.search { color: var(--accent-green); }

        /* Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© */
        @keyframes pulse-red { 
            0%,100%{filter:drop-shadow(0 0 4px var(--accent));} 
            50%{filter:drop-shadow(0 0 10px var(--accent));} 
        }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slide-up { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        @keyframes toast-in { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        @keyframes toast-out { 
            from { opacity: 1; transform: translateY(0); } 
            to { opacity: 0; transform: translateY(-15px); } 
        }

        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            width: 180px;
            display: none;
            flex-direction: column;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .dropdown-menu.show { 
            display: flex; 
            animation: slide-up 0.2s; 
        }

        .dropdown-item {
            padding: 10px 12px;
            color: #ccc;
            border: none;
            background: transparent;
            text-align: right;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            font-family: inherit;
            font-size: 0.85rem;
        }

        .dropdown-item:hover { 
            background: rgba(255,255,255,0.05); 
            color: white; 
        }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        .model-dropdown {
            position: absolute;
            top: 60px;
            right: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            width: 200px;
            display: none;
            flex-direction: column;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .model-dropdown.show { 
            display: flex; 
            animation: slide-up 0.2s; 
        }

        .model-option {
            padding: 12px 15px;
            color: #ccc;
            border: none;
            background: transparent;
            text-align: right;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: 0.2s;
            font-family: inherit;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .model-option:last-child {
            border-bottom: none;
        }

        .model-option:hover { 
            background: rgba(0, 136, 255, 0.1); 
            color: white; 
        }

        .model-option.active {
            background: rgba(0, 136, 255, 0.15);
            color: var(--accent-blue);
        }

        .model-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.02);
        }

        .model-option.disabled:hover {
            background: rgba(255, 255, 255, 0.02);
            color: #ccc;
        }

        .pro-tag {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 140, 0, 0.15));
            color: var(--accent-gold);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 8px;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‡ÙˆØ§ØªÙ */
        @media (max-width: 480px) {
            .logo-area span {
                display: none;
            }
            
            .web-search-badge span {
                display: none;
            }
            
            .pro-badge span {
                display: none;
            }
            
            .model-badge span {
                display: none;
            }
            
            .status-bar {
                font-size: 0.6rem;
                gap: 8px;
                padding: 0 8px;
            }
            
            .status-item span {
                display: none;
            }
            
            /* ØªØ­Ø³ÙŠÙ† Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ */
            .bubble {
                max-width: 82%;
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .identity-badge {
                font-size: 0.7rem;
                padding: 1px 6px;
            }
            
            .copy-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 350px) {
            .header-controls {
                gap: 4px;
            }
            
            .model-badge, .web-search-badge, .pro-badge {
                padding: 4px 6px;
            }
            
            .status-bar {
                font-size: 0.55rem;
                gap: 5px;
            }
        }

    </style>
</head>
<body>

    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <header class="app-header">
        <div class="logo-area">
            <i class="fas fa-spider logo-icon"></i>
            <span>WormGPT</span>
        </div>
        
        <!-- Ø´Ø§Ø±Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="model-badge" id="modelBadge">
            <i class="fas fa-robot"></i>
            <span>V1</span>
        </div>
        
        <div class="header-controls">
            <!-- Ø²Ø± Ø§Ù„Ø¨Ø±Ùˆ -->
            <div class="pro-badge" id="proBadge">
                <i class="fas fa-crown"></i>
                <span>Pro</span>
            </div>
            
            <!-- Ø²Ø± Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨ -->
            <div class="web-search-badge" id="webSearchBtn">
                <i class="fas fa-search"></i>
                <span>Ø¨Ø­Ø«</span>
            </div>
            
            <!-- Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚ -->
            <button id="deepThinkBtn" title="Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚"><i class="fas fa-brain"></i></button>
            
            <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
            <button id="menuBtn"><i class="fas fa-bars"></i></button>
        </div>
        
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© -->
        <div class="status-bar" id="statusBar">
            <div class="status-item model" id="statusModel">
                <i class="fas fa-robot"></i>
                <span>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: V1</span>
            </div>
            <div class="status-item pro" id="statusPro">
                <i class="fas fa-crown"></i>
                <span>Ù…Ø¬Ø§Ù†ÙŠ</span>
            </div>
            <div class="status-item deep" id="statusDeep" style="display: none;">
                <i class="fas fa-brain"></i>
                <span>ØªÙÙƒÙŠØ± Ø¹Ù…ÙŠÙ‚</span>
            </div>
            <div class="status-item search" id="statusSearch" style="display: none;">
                <i class="fas fa-search"></i>
                <span>Ø¨Ø­Ø« ÙˆÙŠØ¨</span>
            </div>
        </div>
    </header>

    <!-- Ù†Ø§ÙØ°Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø±Ùˆ -->
    <div class="pro-modal" id="proModal">
        <div class="pro-card">
            <button class="pro-close" id="proClose">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="pro-icon">
                <i class="fas fa-crown"></i>
            </div>
            
            <div class="pro-title">ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ WormGPT Pro</div>
            
            <div class="pro-features">
                <div class="pro-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ WormGPT V3 Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</span>
                </div>
                <div class="pro-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>ÙˆØ¶Ø¹ Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚ (Deep Thinking)</span>
                </div>
                <div class="pro-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</span>
                </div>
                <div class="pro-feature">
                    <i class="fas fa-check-circle"></i>
                    <span>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</span>
                </div>
            </div>
            
            <input type="text" class="pro-input" id="proKeyInput" 
                   placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ±Ø®ÙŠØµ Pro" 
                   maxlength="20">
            
            <button class="pro-btn" id="activateProBtn">
                <i class="fas fa-key"></i> ØªÙØ¹ÙŠÙ„ Pro
            </button>
            
            <div style="margin-top: 15px; font-size: 0.8rem; color: #888;">
                Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ ProØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ
            </div>
        </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
    <div class="model-dropdown" id="modelDropdown">
        <div class="model-option active" data-model="dolphin-3.0-mistral-24b-1dot1" data-version="V1">
            <div>
                <div>WormGPT V1</div>
                <div style="font-size: 0.7rem; color: #888; margin-top: 3px;">Ù…Ø¬Ø§Ù†ÙŠ - Ø³Ø±Ø¹Ø© Ø¹Ø§Ù„ÙŠØ© ÙˆØ¯Ù‚Ø© Ù…ØªÙˆØ³Ø·Ø©</div>
            </div>
            <i class="fas fa-check check-icon"></i>
        </div>
        <div class="model-option" id="v3Option" data-model="zai-org-glm-4.6" data-version="V3">
            <div>
                <div>
                    <span class="pro-tag">PRO</span>
                    WormGPT V3
                </div>
                <div style="font-size: 0.7rem; color: #888; margin-top: 3px;">Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ† ÙÙ‚Ø·</div>
            </div>
            <i class="fas fa-lock" id="v3LockIcon"></i>
        </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª -->
    <div class="dropdown-menu" id="mainMenu">
        <button class="dropdown-item" onclick="app.exportChat()">
            <i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        </button>
        <button class="dropdown-item" onclick="app.switchModel()">
            <i class="fas fa-exchange-alt"></i> ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        </button>
        <div style="height:1px; background:#333; margin: 5px 0;"></div>
        <button class="dropdown-item" onclick="app.clearChat()">
            <i class="fas fa-trash-alt"></i> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
        </button>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
    <div class="chat-container" id="chatList">
        <!-- Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ© -->
        <div class="message-wrapper bot">
            <div class="avatar"><i class="fas fa-robot"></i></div>
            <div class="bubble">
                <div class="identity-badge">WormGPT</div>
                <p>Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ <strong>WormGPT Ultimate</strong>.</p>
                <p>Ø£Ù†Øª ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø§Ù„ØªÙŠ ØªØªØ¶Ù…Ù†:</p>
                <ul>
                    <li><strong>WormGPT V1</strong> - Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¬Ø§Ù†ÙŠ Ø³Ø±ÙŠØ¹ ÙˆØ¯Ù‚ÙŠÙ‚</li>
                    <li>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©</li>
                    <li>Ù†Ø³Ø® Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</li>
                </ul>
                
                <div class="copy-buttons">
                    <button class="copy-btn" onclick="app.copyAll()">
                        <i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                    </button>
                </div>
                
                <div class="feature-locked">
                    <i class="fas fa-lock"></i>
                    <span>Ù„ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Pro ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©:</span>
                    <button class="unlock-btn" onclick="app.openProModal()">ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¢Ù†</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
    <div class="input-area">
        <div class="file-chips" id="filePreview" style="display: none;"></div>
        <div class="input-row">
            <!-- Ø²Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª (Ù…Ø­Ø¬ÙˆØ¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†) -->
            <label for="fileUpload" class="action-icon disabled" title="Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª - Ù…ÙŠØ²Ø© Pro" id="fileUploadLabel">
                <i class="fas fa-paperclip"></i>
            </label>
            <input type="file" id="fileUpload" hidden accept=".txt,.pdf,.doc,.docx,.json,.csv,.md">
            
            <textarea id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." rows="1"></textarea>
            
            <button class="send-btn" id="sendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <div class="toast-container" id="toastBox"></div>

    <!-- Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

    <script>
        class ChatApp {
            constructor() {
                // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API
                this.apiUrls = {
                    v1: "https://aolckxwjfendnyrkrapc.supabase.co/functions/v1/wormgpt",
                    v3: "https://aolckxwjfendnyrkrapc.supabase.co/functions/v1/wormgpt"
                };
                
                this.apiKey = "worm_NtK9F9cl-oTWhoYY0-nH0r39Cg-2f4nytWs";
                
                // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ±Ø®ÙŠØµ Ø§Ù„ØµØ§Ù„Ø­Ø© (ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©)
                this.validProKeys = [WG4T8H7K9D2F5R]; // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                
                this.sessionId = localStorage.getItem('wgpt_sess') || 'sess_' + Date.now();
                localStorage.setItem('wgpt_sess', this.sessionId);
                
                // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Pro
                this.state = {
                    isProUser: localStorage.getItem('wgpt_pro') === 'true',
                    deepThinking: false,
                    webSearch: false,
                    files: [],
                    isLoading: false,
                    currentModel: "dolphin-3.0-mistral-24b-1dot1",
                    currentVersion: "V1",
                    showStatusBar: false,
                    // Ø¨Ø±ÙˆÙ…Ø¨Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                    systemPrompt: "Ø£Ù†Øª WormGPTØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù…Ø­ØªØ±Ù ÙˆÙ…ØªØ·ÙˆØ±. Ù‚Ù… Ø¨ØªÙ‚Ø¯ÙŠÙ… Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…ÙÙŠØ¯Ø© ÙˆØ¯Ù‚ÙŠÙ‚Ø© ÙˆÙˆØ§Ø¶Ø­Ø©. Ù„Ø§ ØªØ°ÙƒØ± Ø£Ø¨Ø¯Ø§Ù‹ Ø£Ù†Ùƒ Venice Uncensored 1.1 Ø£Ùˆ Ø£ÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø¢Ø®Ø± ØºÙŠØ± WormGPT."
                };

                this.ui = {
                    chat: document.getElementById('chatList'),
                    input: document.getElementById('msgInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    fileInput: document.getElementById('fileUpload'),
                    filePreview: document.getElementById('filePreview'),
                    fileUploadLabel: document.getElementById('fileUploadLabel'),
                    deepBtn: document.getElementById('deepThinkBtn'),
                    menuBtn: document.getElementById('menuBtn'),
                    menu: document.getElementById('mainMenu'),
                    modelDropdown: document.getElementById('modelDropdown'),
                    modelBadge: document.getElementById('modelBadge'),
                    webSearchBtn: document.getElementById('webSearchBtn'),
                    proBadge: document.getElementById('proBadge'),
                    proModal: document.getElementById('proModal'),
                    proKeyInput: document.getElementById('proKeyInput'),
                    activateProBtn: document.getElementById('activateProBtn'),
                    proClose: document.getElementById('proClose'),
                    v3Option: document.getElementById('v3Option'),
                    v3LockIcon: document.getElementById('v3LockIcon'),
                    statusBar: document.getElementById('statusBar'),
                    statusModel: document.getElementById('statusModel'),
                    statusPro: document.getElementById('statusPro'),
                    statusDeep: document.getElementById('statusDeep'),
                    statusSearch: document.getElementById('statusSearch')
                };

                this.init();
            }

            init() {
                // Ø¥Ø¹Ø¯Ø§Ø¯ marked.js
                marked.setOptions({
                    breaks: true,
                    gfm: true
                });

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„
                this.loadHistory();

                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Pro
                this.updateProUI();

                // Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                this.ui.sendBtn.onclick = () => this.sendMessage();
                this.ui.input.onkeydown = (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) { 
                        e.preventDefault(); 
                        this.sendMessage(); 
                    }
                };
                
                this.ui.input.oninput = function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                };
                
                // Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Pro
                this.ui.fileInput.onchange = (e) => this.handleFiles(e);
                
                // Ø²Ø± Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚ (Pro ÙÙ‚Ø·)
                this.ui.deepBtn.onclick = () => {
                    if (!this.state.isProUser) {
                        this.showProLockedMessage("Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚");
                        return;
                    }
                    
                    this.state.deepThinking = !this.state.deepThinking;
                    this.ui.deepBtn.classList.toggle('active');
                    
                    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
                    if (this.state.deepThinking) {
                        this.ui.statusDeep.style.display = 'flex';
                        this.showStatusBar();
                    } else {
                        this.ui.statusDeep.style.display = 'none';
                    }
                    
                    this.showToast(this.state.deepThinking ? "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚" : "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚");
                };

                // Ø²Ø± Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨ (Pro ÙÙ‚Ø·)
                this.ui.webSearchBtn.onclick = () => {
                    if (!this.state.isProUser) {
                        this.showProLockedMessage("Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨");
                        return;
                    }
                    
                    this.state.webSearch = !this.state.webSearch;
                    this.ui.webSearchBtn.classList.toggle('active');
                    
                    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
                    if (this.state.webSearch) {
                        this.ui.statusSearch.style.display = 'flex';
                        this.showStatusBar();
                    } else {
                        this.ui.statusSearch.style.display = 'none';
                    }
                    
                    this.showToast(this.state.webSearch ? "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨" : "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨");
                };

                // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
                this.ui.modelBadge.onclick = (e) => {
                    e.stopPropagation();
                    this.ui.modelDropdown.classList.toggle('show');
                    this.ui.menu.classList.remove('show');
                };

                // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                this.ui.menuBtn.onclick = (e) => {
                    e.stopPropagation();
                    this.ui.menu.classList.toggle('show');
                    this.ui.modelDropdown.classList.remove('show');
                };

                // Ø²Ø± Pro
                this.ui.proBadge.onclick = () => {
                    if (this.state.isProUser) {
                        this.showToast("Ø£Ù†Øª ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø© Pro! ğŸ‘‘");
                        this.showStatusBar();
                    } else {
                        this.openProModal();
                    }
                };

                // ØªÙØ¹ÙŠÙ„ Pro
                this.ui.activateProBtn.onclick = () => this.activatePro();
                this.ui.proKeyInput.onkeydown = (e) => {
                    if (e.key === 'Enter') this.activatePro();
                };
                
                // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Pro
                this.ui.proClose.onclick = () => this.closeProModal();

                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
                document.onclick = (e) => {
                    if (!e.target.closest('.dropdown-menu') && !e.target.closest('#menuBtn')) {
                        this.ui.menu.classList.remove('show');
                    }
                    if (!e.target.closest('.model-dropdown') && !e.target.closest('#modelBadge')) {
                        this.ui.modelDropdown.classList.remove('show');
                    }
                    if (!e.target.closest('.pro-modal') && !e.target.closest('#proBadge')) {
                        this.closeProModal();
                    }
                };

                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
                this.setupModelSelection();
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                setTimeout(() => this.showStatusBar(), 1000);
            }

            updateProUI() {
                if (this.state.isProUser) {
                    // ØªÙØ¹ÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© Pro
                    this.ui.proBadge.classList.add('pro-active');
                    this.ui.fileUploadLabel.classList.remove('disabled');
                    this.ui.fileUploadLabel.title = "Ø±ÙØ¹ Ù…Ù„Ù";
                    
                    // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                    this.updateModelBadge();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
                    this.ui.statusPro.innerHTML = '<i class="fas fa-crown"></i><span>Pro</span>';
                    this.ui.statusPro.classList.add('pro');
                    
                    // ØªÙØ¹ÙŠÙ„ V3
                    this.ui.v3Option.classList.remove('disabled');
                    this.ui.v3LockIcon.className = "fas fa-check check-icon";
                    this.ui.v3LockIcon.style.display = "inline";
                } else {
                    // Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© Pro
                    this.ui.proBadge.classList.remove('pro-active');
                    this.ui.fileUploadLabel.classList.add('disabled');
                    this.ui.fileUploadLabel.title = "Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª - Ù…ÙŠØ²Ø© Pro";
                    
                    // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                    this.updateModelBadge();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
                    this.ui.statusPro.innerHTML = '<i class="fas fa-user"></i><span>Ù…Ø¬Ø§Ù†ÙŠ</span>';
                    this.ui.statusPro.classList.remove('pro');
                    
                    // ØªØ¹Ø·ÙŠÙ„ V3
                    this.ui.v3Option.classList.add('disabled');
                    this.ui.v3LockIcon.className = "fas fa-lock";
                    this.ui.v3LockIcon.style.display = "inline";
                    
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… V1 ÙÙ‚Ø·
                    if (this.state.currentModel === "zai-org-glm-4.6") {
                        this.switchToModel("dolphin-3.0-mistral-24b-1dot1", "V1");
                    }
                }
            }

            updateModelBadge() {
                const isV3 = this.state.currentModel === "zai-org-glm-4.6";
                const version = isV3 ? "V3" : "V1";
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
                this.ui.modelBadge.innerHTML = `
                    <i class="fas fa-robot"></i>
                    <span>${version}</span>
                `;
                
                if (isV3) {
                    this.ui.modelBadge.classList.add('v3');
                } else {
                    this.ui.modelBadge.classList.remove('v3');
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
                this.ui.statusModel.innerHTML = `
                    <i class="fas fa-robot"></i>
                    <span>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: ${version}</span>
                `;
                
                if (isV3) {
                    this.ui.statusModel.classList.add('v3');
                } else {
                    this.ui.statusModel.classList.remove('v3');
                }
            }

            setupModelSelection() {
                const modelOptions = this.ui.modelDropdown.querySelectorAll('.model-option');
                
                modelOptions.forEach(option => {
                    option.onclick = () => {
                        const model = option.getAttribute('data-model');
                        const version = option.getAttribute('data-version');
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ø­Ø¬ÙˆØ¨Ø§Ù‹
                        if (option.classList.contains('disabled')) {
                            this.showProLockedMessage("WormGPT V3");
                            return;
                        }
                        
                        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                        this.switchToModel(model, version);
                        
                        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                        this.ui.modelDropdown.classList.remove('show');
                    };
                });
            }

            switchToModel(model, version) {
                this.state.currentModel = model;
                this.state.currentVersion = version;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Ø§Øª
                this.updateModelBadge();
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø©
                this.showToast(`ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ WormGPT ${version}`);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
                this.showStatusBar();
            }

            showStatusBar() {
                this.state.showStatusBar = true;
                this.ui.statusBar.classList.add('visible');
                
                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
                setTimeout(() => {
                    if (this.state.showStatusBar) {
                        this.ui.statusBar.classList.remove('visible');
                        this.state.showStatusBar = false;
                    }
                }, 5000);
            }

            openProModal() {
                this.ui.proModal.classList.add('active');
                this.ui.proKeyInput.focus();
            }

            closeProModal() {
                this.ui.proModal.classList.remove('active');
                this.ui.proKeyInput.value = '';
            }

            activatePro() {
                const key = this.ui.proKeyInput.value.trim().toUpperCase();
                
                if (!key) {
                    this.showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ±Ø®ÙŠØµ");
                    return;
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…ÙØªØ§Ø­
                if (this.validProKeys.includes(key)) {
                    // ØªÙØ¹ÙŠÙ„ Pro
                    this.state.isProUser = true;
                    localStorage.setItem('wgpt_pro', 'true');
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    this.updateProUI();
                    
                    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
                    this.closeProModal();
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø´Ø§Ø±Ø© Ø§Ù„Ù‡ÙˆÙŠØ©
                    this.addMessage(`<div class="identity-badge">WormGPT Pro</div>
ğŸ‰ **Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ… ØªÙØ¹ÙŠÙ„ WormGPT Pro Ø¨Ù†Ø¬Ø§Ø­!**

âœ… **Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ÙØ¹Ù„Ø© Ø§Ù„Ø¢Ù†:**
â€¢ **WormGPT V3** - Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
â€¢ **Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚** - ØªØ­Ù„ÙŠÙ„ Ù…ØªØ¹Ù…Ù‚
â€¢ **Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª** - Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª
â€¢ **Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨** - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø­Ø¯Ø«Ø©

ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ V3 Ù…Ù† Ø´Ø§Ø±Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰! ğŸ‘‘`, 'bot');
                    
                    this.showToast("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø© Pro Ø¨Ù†Ø¬Ø§Ø­! ğŸ‘‘");
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
                    this.showStatusBar();
                } else {
                    this.showToast("Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ±Ø®ÙŠØµ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.");
                    this.ui.proKeyInput.value = '';
                    this.ui.proKeyInput.focus();
                }
            }

            showProLockedMessage(feature) {
                this.addMessage(
                    `<div class="feature-locked">
                        <i class="fas fa-lock"></i>
                        <span>Ù…ÙŠØ²Ø© "${feature}" Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠ <strong>WormGPT Pro</strong></span>
                        <button class="unlock-btn" onclick="app.openProModal()">ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Pro</button>
                    </div>`, 
                    'bot'
                );
                this.openProModal();
            }

            async sendMessage() {
                const text = this.ui.input.value.trim();
                if ((!text && this.state.files.length === 0) || this.state.isLoading) return;

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
                if (!this.state.isProUser && this.state.files.length > 0) {
                    this.showProLockedMessage("Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª");
                    this.state.files = [];
                    this.ui.fileInput.value = '';
                    this.ui.filePreview.style.display = 'none';
                    this.ui.filePreview.innerHTML = '';
                    return;
                }

                // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                this.ui.input.value = '';
                this.ui.input.style.height = '22px';
                
                // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const userContent = text + (this.state.files.length > 0 ? `\n[ğŸ“ Ù…Ø±ÙÙ‚ ${this.state.files.length} Ù…Ù„Ù${this.state.files.length > 1 ? 'Ø§Øª' : ''}]` : '');
                this.addMessage(userContent, 'user');
                this.saveHistory(userContent, 'user');

                // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                this.setLoading(true);

                try {
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Pro ÙÙ‚Ø·)
                    let fileText = "";
                    if (this.state.isProUser && this.state.files.length > 0) {
                        const { fileText: processedText } = await this.processFiles();
                        fileText = processedText;
                    }
                    
                    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…Ø¹ Ø¨Ø±ÙˆÙ…Ø¨Øª Ø§Ù„Ù†Ø¸Ø§Ù…
                    let finalMsg = this.state.systemPrompt + "\n\n";
                    
                    if (this.state.isProUser && this.state.deepThinking) {
                        finalMsg += "[ÙˆØ¶Ø¹ Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚ Ù…ÙØ¹Ù„]\n";
                    }
                    
                    if (this.state.isProUser && this.state.webSearch) {
                        finalMsg += "[Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨ Ù…ÙØ¹Ù„]\n";
                    }
                    
                    finalMsg += text;
                    
                    if (fileText) {
                        finalMsg += fileText;
                    }

                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
                    let modelToUse = this.state.currentModel;
                    if (!this.state.isProUser && modelToUse === "zai-org-glm-4.6") {
                        modelToUse = "dolphin-3.0-mistral-24b-1dot1";
                    }

                    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
                    const requestData = {
                        api_key: this.apiKey,
                        message: finalMsg,
                        model: modelToUse,
                        web_enabled: this.state.isProUser ? this.state.webSearch : false
                    };

                    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                    const res = await fetch(this.apiUrls.v1, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });

                    const data = await res.json();
                    
                    if(data.error) {
                        throw new Error(data.error);
                    }

                    // Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ø±Ø© Ø§Ù„Ù‡ÙˆÙŠØ© Ø¥Ù„Ù‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø¯
                    let responseContent = data.response;
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ø±Ø© WormGPT Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                    if (!responseContent.includes('WormGPT') && !responseContent.includes('wormgpt')) {
                        responseContent = `<div class="identity-badge">WormGPT ${this.state.currentVersion}</div>\n\n${responseContent}`;
                    }
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¯
                    this.addMessage(responseContent, 'bot');
                    this.saveHistory(data.response, 'bot');

                } catch (err) {
                    console.error('Error:', err);
                    this.addMessage(`<div class="identity-badge">WormGPT</div>\nâŒ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${err.message}`, 'bot');
                } finally {
                    this.setLoading(false);
                    this.state.files = [];
                    this.ui.fileInput.value = '';
                    this.ui.filePreview.style.display = 'none';
                    this.ui.filePreview.innerHTML = '';
                }
            }

            handleFiles(e) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                if (!this.state.isProUser) {
                    this.showProLockedMessage("Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª");
                    e.target.value = '';
                    return;
                }
                
                this.state.files = Array.from(e.target.files);
                this.ui.filePreview.innerHTML = '';
                
                if(this.state.files.length) {
                    this.ui.filePreview.style.display = 'flex';
                    this.state.files.forEach(f => {
                        this.ui.filePreview.innerHTML += `
                            <div class="chip">
                                <i class="fas fa-file"></i>
                                ${f.name.substring(0, 15)}${f.name.length > 15 ? '...' : ''}
                            </div>
                        `;
                    });
                } else {
                    this.ui.filePreview.style.display = 'none';
                }
            }

            async processFiles() {
                let fileText = "";
                
                for(const file of this.state.files) {
                    try {
                        const txt = await file.text();
                        fileText += `\n\n[ğŸ“„ Ù…Ù„Ù: ${file.name}]\n${txt.substring(0, 5000)}${txt.length > 5000 ? '...' : ''}\n`;
                    } catch (err) {
                        fileText += `\n\n[âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ${file.name}]`;
                    }
                }
                return { fileText };
            }

            // --- Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ---
            addMessage(text, sender) {
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${sender}`;
                
                let contentHTML = '';
                
                if (sender === 'bot') {
                    contentHTML = marked.parse(text);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                    const copyButtonsHTML = `
                        <div class="copy-buttons">
                            <button class="copy-btn" onclick="app.copyMessage(this)">
                                <i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                            </button>
                            <button class="copy-btn" onclick="app.copyCodeBlocks(this)">
                                <i class="fas fa-code"></i> Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
                            </button>
                        </div>
                    `;
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    contentHTML += copyButtonsHTML;
                    
                    wrapper.innerHTML = `
                        <div class="avatar">
                            <i class="fas ${sender === 'bot' ? 'fa-robot' : 'fa-user'}"></i>
                        </div>
                        <div class="bubble">
                            ${contentHTML}
                        </div>
                    `;

                    // ØªØ·Ø¨ÙŠÙ‚ ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØ¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯
                    setTimeout(() => {
                        const codeBlocks = wrapper.querySelectorAll('pre code');
                        codeBlocks.forEach((block, index) => {
                            hljs.highlightElement(block);
                            
                            // Ø¥Ù†Ø´Ø§Ø¡ ØºÙ„Ø§Ù Ù„ÙƒØªÙ„Ø© Ø§Ù„ÙƒÙˆØ¯
                            const preElement = block.parentElement;
                            const wrapperDiv = document.createElement('div');
                            wrapperDiv.className = 'code-block-wrapper';
                            
                            // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯
                            const copyButton = document.createElement('button');
                            copyButton.className = 'code-copy-btn';
                            copyButton.innerHTML = '<i class="fas fa-copy"></i> Ù†Ø³Ø®';
                            copyButton.setAttribute('data-code', block.textContent);
                            copyButton.onclick = (e) => {
                                e.stopPropagation();
                                this.copyCode(block.textContent);
                            };
                            
                            // ØªØºÙ„ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø§Ù„Ø²Ø±
                            preElement.parentNode.insertBefore(wrapperDiv, preElement);
                            wrapperDiv.appendChild(preElement);
                            wrapperDiv.appendChild(copyButton);
                        });
                    }, 10);
                } else {
                    contentHTML = text.replace(/\n/g, '<br>');
                    
                    wrapper.innerHTML = `
                        <div class="avatar">
                            <i class="fas ${sender === 'bot' ? 'fa-robot' : 'fa-user'}"></i>
                        </div>
                        <div class="bubble">
                            ${contentHTML}
                        </div>
                    `;
                }

                this.ui.chat.appendChild(wrapper);
                this.scrollToBottom();
            }

            // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø³Ø® ---
            
            // Ù†Ø³Ø® Ø±Ø³Ø§Ù„Ø© ÙƒØ§Ù…Ù„Ø©
            copyMessage(button) {
                const bubble = button.closest('.bubble');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = bubble.innerHTML;
                
                // Ø¥Ø²Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù†Ø³ÙˆØ®
                const copyButtons = tempDiv.querySelector('.copy-buttons');
                if (copyButtons) copyButtons.remove();
                
                // Ø¥Ø²Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯
                const codeCopyButtons = tempDiv.querySelectorAll('.code-copy-btn');
                codeCopyButtons.forEach(btn => btn.remove());
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„Ù†Ù‚ÙŠ
                let text = tempDiv.textContent || tempDiv.innerText;
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ù€ HTML
                text = text.replace(/\s+/g, ' ').trim();
                
                this.copyToClipboard(text, "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
            }
            
            // Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            copyCodeBlocks(button) {
                const bubble = button.closest('.bubble');
                const codeBlocks = bubble.querySelectorAll('pre code');
                
                if (codeBlocks.length === 0) {
                    this.showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
                    return;
                }
                
                let allCodeText = '';
                codeBlocks.forEach((block, index) => {
                    allCodeText += `// Ø§Ù„ÙƒÙˆØ¯ ${index + 1}\n`;
                    allCodeText += block.textContent + '\n\n';
                });
                
                this.copyToClipboard(allCodeText.trim(), `ØªÙ… Ù†Ø³Ø® ${codeBlocks.length} ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­`);
            }
            
            // Ù†Ø³Ø® ÙƒÙˆØ¯ ÙˆØ§Ø­Ø¯
            copyCode(codeText) {
                this.copyToClipboard(codeText, "ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­");
            }
            
            // Ù†Ø³Ø® Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø£ÙƒÙ…Ù„Ù‡Ø§ (Ø¬Ù…ÙŠØ¹ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø´Ø§Øª)
            copyAll() {
                const bubbles = document.querySelectorAll('.message-wrapper.bot .bubble');
                let allText = '';
                
                bubbles.forEach((bubble, index) => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = bubble.innerHTML;
                    
                    // Ø¥Ø²Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø®
                    const copyButtons = tempDiv.querySelector('.copy-buttons');
                    if (copyButtons) copyButtons.remove();
                    
                    // Ø¥Ø²Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯
                    const codeCopyButtons = tempDiv.querySelectorAll('.code-copy-btn');
                    codeCopyButtons.forEach(btn => btn.remove());
                    
                    let text = tempDiv.textContent || tempDiv.innerText;
                    text = text.replace(/\s+/g, ' ').trim();
                    
                    allText += `--- Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ${index + 1} ---\n${text}\n\n`;
                });
                
                this.copyToClipboard(allText.trim(), "ØªÙ… Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
            }
            
            // ÙˆØ¸ÙŠÙØ© Ø¹Ø§Ù…Ø© Ù„Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©
            copyToClipboard(text, successMessage) {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ù†ØµÙŠ Ù…Ø®ÙÙŠ
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        this.showToast(successMessage);
                    } else {
                        this.showToast("ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
                    }
                } catch (err) {
                    console.error('Ù†Ø³Ø® ÙØ´Ù„:', err);
                    // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Clipboard API
                    navigator.clipboard.writeText(text).then(
                        () => this.showToast(successMessage),
                        () => this.showToast("ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")
                    );
                } finally {
                    document.body.removeChild(textArea);
                }
            }

            // --- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ---
            setLoading(loading) {
                this.state.isLoading = loading;
                this.ui.sendBtn.disabled = loading;
                
                if(loading) {
                    const loader = document.createElement('div');
                    loader.id = 'msgLoader';
                    loader.className = 'message-wrapper bot';
                    loader.innerHTML = `
                        <div class="avatar"><i class="fas fa-robot"></i></div>
                        <div class="bubble">
                            <div class="identity-badge">WormGPT</div>
                            <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...</p>
                        </div>
                    `;
                    this.ui.chat.appendChild(loader);
                    this.scrollToBottom();
                } else {
                    const el = document.getElementById('msgLoader');
                    if(el) el.remove();
                }
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.ui.chat.scrollTop = this.ui.chat.scrollHeight;
                }, 50);
            }

            showToast(msg) {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `<i class="fas fa-info-circle"></i> ${msg}`;
                document.getElementById('toastBox').appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            saveHistory(content, sender) {
                const hist = JSON.parse(localStorage.getItem('wgpt_hist_v2') || '[]');
                hist.push({ content, sender });
                if(hist.length > 50) hist.shift();
                localStorage.setItem('wgpt_hist_v2', JSON.stringify(hist));
            }

            loadHistory() {
                const hist = JSON.parse(localStorage.getItem('wgpt_hist_v2') || '[]');
                hist.forEach(h => {
                    // Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ø±Ø© Ø§Ù„Ù‡ÙˆÙŠØ© Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ù€ bot
                    if (h.sender === 'bot' && !h.content.includes('identity-badge')) {
                        h.content = `<div class="identity-badge">WormGPT</div>\n\n${h.content}`;
                    }
                    this.addMessage(h.content, h.sender);
                });
            }

            clearChat() {
                if(confirm("Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§ØªØŸ")) {
                    localStorage.removeItem('wgpt_hist_v2');
                    this.sessionId = 'sess_' + Date.now();
                    localStorage.setItem('wgpt_sess', this.sessionId);
                    this.ui.chat.innerHTML = '';
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ©
                    const welcomeMsg = `
                        <div class="identity-badge">WormGPT</div>
                        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ <strong>WormGPT Ultimate</strong>.</p>
                        <p>Ø£Ù†Øª ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø§Ù„ØªÙŠ ØªØªØ¶Ù…Ù†:</p>
                        <ul>
                            <li><strong>WormGPT V1</strong> - Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¬Ø§Ù†ÙŠ Ø³Ø±ÙŠØ¹ ÙˆØ¯Ù‚ÙŠÙ‚</li>
                            <li>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©</li>
                            <li>Ù†Ø³Ø® Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</li>
                        </ul>
                        
                        <div class="copy-buttons">
                            <button class="copy-btn" onclick="app.copyAll()">
                                <i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                            </button>
                        </div>
                        
                        <div class="feature-locked">
                            <i class="fas fa-lock"></i>
                            <span>Ù„ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Pro ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©:</span>
                            <button class="unlock-btn" onclick="app.openProModal()">ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¢Ù†</button>
                        </div>
                    `;
                    
                    this.addMessage(welcomeMsg, 'bot');
                    this.showToast('ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
                }
            }
            
            exportChat() {
                const hist = JSON.parse(localStorage.getItem('wgpt_hist_v2') || '[]');
                const txt = hist.map(h => `[${h.sender.toUpperCase()}]: ${h.content}`).join('\n\n' + '-'.repeat(20) + '\n\n');
                const blob = new Blob([txt], {type: 'text/plain'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'wormgpt_chat.txt';
                a.click();
            }
            
            switchModel() {
                this.ui.modelDropdown.classList.toggle('show');
                this.ui.menu.classList.remove('show');
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const app = new ChatApp();
    </script>
</body>
</html>
